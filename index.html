<!doctype html>
<html lang="pt-BR">
  <head>
    <title>Relátorio de vendas</title>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

    <style>
        header {
            background-color: whitesmoke;
            display: flex;
            align-items: baseline;
            justify-content: center;
        }

        h1 {
            font-family: Helvetica, sans-serif;
        }

        main {
            width: 960px;
            margin: auto;
            background-color: white;
        }

        tbody tr:hover {
            background-color: lightgrey;
            transition: all ease;
        }

        .modal {
            display: none;
            z-index: 3;
        }

        #relatorioVendas {
            display: none;
        }

        .prevent-select {
            -webkit-user-select: none; /* Safari */
            -ms-user-select: none; /* IE 10 and IE 11 */
            user-select: none; /* Standard syntax */
        }
    </style>
  </head>
  <body>
    <header class="text-center pt-3 pb-3 prevent-select">
        <h1>Consórsios</h1>
        <h6>.LTDA</h6>
    </header>

    <main class="text-center mt-2">
        <table class="table" id="vendas">
            <thead class="prevent-select">
                <tr>
                    <th style="padding-bottom: 18px;">Código do vendedor</th>
                    <th style="padding-bottom: 18px;">Nome do vendedor</th>
                    <th style="padding-bottom: 18px;">Cargo do vendedor</th>
                    <th style="padding-bottom: 18px;">Código da venda</th>
                    <th style="padding-bottom: 18px;">Valor da venda</th>
                    <th><button type="button" class="btn btn-primary text-center" onclick="modalAdd.style.display = 'block'">+Adicionar</button></th>
                </tr>
            </thead>
            <tbody id="vendasTableBody"></tbody>
        </table>

        <button type="button" class="btn btn-primary" onclick="infoRelatorio()">Gerar relatório de vendas</button>

        <div id="relatorioVendas" class="mt-4">
            <table class="table">
                <thead class="prevent-select">
                    <tr>
                        <th>Nome</th>
                        <th>Cargo</th>
                        <th>Total de vendas</th>
                        <th>Maior venda</th>
                        <th>Comissão</th>
                    </tr>
                </thead>
                <tbody id="relatorioTableBody"></tbody>
            </table>
        </div>

        <!-- modal Add -->
        <div id="modalAdicionarContato" class="modal">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Adicionar nova venda</h5>
                        <button type="button" class="close" id="closeModal" onclick="modalAdd.style.display = 'none'">&times;</button>
                    </div>
                    <div class="modal-body">
                        <p>Formulário para adicionar venda.</p>
                        <form id="formAdicionarContato" class="text-left">
                            <div class="form-group">
                                <label for="codVendedor">Código do vendedor:</label>
                                <input type="number" class="form-control" id="codVendedor" required>
                            </div>
                            <div class="form-group">
                                <label for="nome">Nome:</label>
                                <input type="text" class="form-control" id="nome" required>
                            </div>
                            <div class="form-group">
                                <label for="cargo">Cargo:</label>
                                <input type="text" class="form-control" id="cargo" required>
                            </div>
                            <div class="form-group">
                                <label for="codVenda">Código da venda:</label>
                                <input type="number" class="form-control" id="codVenda" required>
                            </div>
                            <div class="form-group">
                                <label for="valorVenda">Valor venda:</label>
                                <input type="number" class="form-control" id="valorVenda" required>
                            </div>
                            <div class="text-center"><button type="submit" class="btn btn-primary">Salvar Contato</button></div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- overlay -->
        <div id="overlay" style="
                    height: 100%;
                    width: 100%;
                    background-color: rgb(0, 0, 0, 0.5);
                    display: none;
                    position: fixed;
                    top: 0;
                    left: 0;
                    z-index: 2;">
        </div>

    </main>

    <script>
        let vendas = [
            {
                codVendedor: '01',
                nomeVendedor: 'Leonardo Brito Gomes',
                cargo: 'Pleno',
                codVenda: '01',
                valorVenda: '30000'
            },

            {
                codVendedor: '02',
                nomeVendedor: 'Gimli, filho de Glóin',
                cargo: 'Júnior',
                codVenda: '03',
                valorVenda: '80'
            },

            {
                codVendedor: '01',
                nomeVendedor: 'Leonardo Brito Gomes',
                cargo: 'Pleno',
                codVenda: '02',
                valorVenda: '200'
            }
        ]
        
        //documents
        const modalAdd = document.getElementById("modalAdicionarContato")
        const form = document.getElementById("formAdicionarContato")
        const relatorioVendas = document.getElementById("relatorioVendas")
        const relatorioVendasBody = document.getElementById("relatorioTableBody")

        
        
        //vendas
        function renderizarTabelaVendas() {
            let vendasTableBody = document.getElementById('vendasTableBody')
            
            vendasTableBody.innerHTML = ''
            vendas.forEach((venda, index) => { 
                venda.valorVenda = parseFloat(venda.valorVenda) //formatar dinheiro
                valorVendaFormatado = venda.valorVenda.toLocaleString('pt-BR', {
                    style: 'currency',
                    currency: 'BRL'
                })

                venda.codVendedor = venda.codVendedor.padStart(2, '0') //formatar numeros
                venda.codVenda = venda.codVenda.padStart(2, '0')
                
                vendasTableBody.innerHTML += `
                        <tr>
                            <td style="padding-top: 20px;">${venda.codVendedor}</td>
                            <td style="padding-top: 20px;">${venda.nomeVendedor}</td>
                            <td style="padding-top: 20px;">${venda.cargo}</td>
                            <td style="padding-top: 20px;">${venda.codVenda}</td>
                            <td style="padding-top: 20px;">${valorVendaFormatado}</td>
                            <td><button type="button" class="btn btn-primary text-center">Editar</button></td>
                            </tr>
                        `
                    })
                }

                function adicionarVenda() {
                    event.preventDefault();
            
                    let codVendedor = document.getElementById("codVendedor").value
                    let nomeVendedor = document.getElementById("nome").value
                    let cargo = document.getElementById("cargo").value
                    let codVenda = document.getElementById("codVenda").value
                    let valorVenda = document.getElementById("valorVenda").value 
                    
                    let venda = {
                        codVendedor,
                        nomeVendedor,
                        cargo,
                        codVenda,
                        valorVenda
                    }
                    
                    vendas.push(venda)
                    form.reset()
                    
                    renderizarTabelaVendas()
                    modalAdd.style.display = 'none'
                }

                //relatorio
                function infoRelatorio() {
                    let vendedores = []
            
                    let codAdd = []
                    
                    vendas.forEach(venda => { 
                        if(codAdd.includes(venda.codVendedor)) { //caso adicionado
                            vendedores.forEach(vendedor => {
                                if(vendedor.nome === venda.nomeVendedor){
                                    vendedor.totalVendas += venda.valorVenda
                                    
                                    if(venda.valorVenda > vendedor.maiorVenda){
                                        vendedor.maiorVenda = venda.valorVenda
                                    }
                                    
                                    if (vendedor.cargo === 'Júnior') {
                                        vendedor.comissao = vendedor.totalVendas * 0.01
                            } else if (vendedor.cargo === 'Pleno') {
                                vendedor.comissao = vendedor.totalVendas * 0.02
                            } else {
                                vendedor.comissao = vendedor.totalVendas * 0.03
                            }
                        }
                    })
                    
                } else { //caso n tenha sido adicionado ainda
                    let nome = venda.nomeVendedor
                    let cargo = venda.cargo
                    let totalVendas = parseFloat(venda.valorVenda)
                    let maiorVenda = parseFloat(venda.valorVenda)

                    if(cargo === 'Júnior') {
                        comissao = totalVendas*0.01
                    } else if(cargo === 'Pleno') {
                        comissao = totalVendas*0.02
                    } else {
                        comissao = totalVendas*0.03
                    }
                    
                    vendedor = {
                            nome,
                            cargo,
                            totalVendas,
                            maiorVenda,
                            comissao
                        }
                        
                        vendedores.push(vendedor)
                        codAdd.push(venda.codVendedor)
                    }
                })

                //sorting
                vendedores.sort((a, b) => b.totalVendas - a.totalVendas);
                
                gerarRelatorio(vendedores)
            }
        
        function gerarRelatorio(vendedores) {
            relatorioVendas.style.display = 'block'
            
            relatorioVendasBody.innerHTML = ''
            
            vendedores.forEach(vendedor => {
                vendedor.totalVendas = vendedor.totalVendas.toLocaleString('pt-BR', {
                    style: 'currency',
                    currency: 'BRL'
                })
                vendedor.maiorVenda = vendedor.maiorVenda.toLocaleString('pt-BR', {
                    style: 'currency',
                    currency: 'BRL'
                })
                vendedor.comissao = vendedor.comissao.toLocaleString('pt-BR', {
                    style: 'currency',
                    currency: 'BRL'
                })

                relatorioVendasBody.innerHTML += `
                    <tr>
                        <td>${vendedor.nome}</td>
                        <td>${vendedor.cargo}</td>
                        <td>${vendedor.totalVendas}</td>
                        <td>${vendedor.maiorVenda}</td>
                        <td>${vendedor.comissao}</td>
                    </tr>
                    `
                })
        }
            
            
        //eventos
        form.addEventListener('submit', adicionarVenda)

        window.addEventListener('DOMContentLoaded', renderizarTabelaVendas)
    </script>
  </body>
</html>